# Development Docker Compose configuration
# Usage: ./scripts/dev.sh
#
# Supports random ports for running multiple workspaces simultaneously.
# All services use multi-arch images for Apple Silicon (M1/M2) compatibility.
#
# Volumes are automatically prefixed with the project name for isolation.

services:
  postgres:
    image: ghcr.io/gui/postgis:18-trixie-postgis-3.6.1
    # Multi-arch image - works on both arm64 (M1/M2) and amd64
    container_name: ${COMPOSE_PROJECT_NAME:-tl}_postgres
    environment:
      POSTGRES_DB: tracks_db
      POSTGRES_USER: tracks_user
      POSTGRES_PASSWORD: tracks_password
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tracks_user -d tracks_db"]
      interval: 5s
      timeout: 5s
      retries: 10

  backend:
    build:
      context: .
      dockerfile: crates/tracks/Dockerfile.dev
    container_name: ${COMPOSE_PROJECT_NAME:-tl}_backend
    environment:
      DATABASE_URL: postgres://tracks_user:tracks_password@postgres:5432/tracks_db
      OBJECT_STORE_PATH: /app/uploads
      PORT: ${BACKEND_INTERNAL_PORT:-3001}
      RUST_LOG: ${RUST_LOG:-info}
      CARGO_TARGET_DIR: /app/target
    ports:
      - "${BACKEND_PORT:-3001}:${BACKEND_INTERNAL_PORT:-3001}"
    volumes:
      # Mount workspace root for dependency resolution
      - ./Cargo.toml:/app/Cargo.toml:cached
      - ./Cargo.lock:/app/Cargo.lock:cached
      # Mount workspace crates
      - ./crates/tracks/src:/app/crates/tracks/src:cached
      - ./crates/tracks/migrations:/app/crates/tracks/migrations:cached
      - ./crates/tracks/Cargo.toml:/app/crates/tracks/Cargo.toml:cached
      - ./crates/tracks/.sqlx:/app/crates/tracks/.sqlx:cached
      - ./crates/test-data:/app/crates/test-data:cached
      - cargo_cache:/usr/local/cargo/registry
      - target_cache:/app/target
      - uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_INTERNAL_PORT:-3001}/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    # Use cargo-watch for hot reloading; run the tracks binary
    command: cargo watch -p tracks -x "run --bin tracks"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend.dev
    container_name: ${COMPOSE_PROJECT_NAME:-tl}_frontend
    environment:
      NODE_ENV: development
      PORT: ${FRONTEND_INTERNAL_PORT:-3000}
      BACKEND_PORT: ${BACKEND_INTERNAL_PORT:-3001}
      # For API proxy - connects to backend container
      BACKEND_URL: http://backend:${BACKEND_INTERNAL_PORT:-3001}
      WATCHPACK_POLLING: "true"
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_INTERNAL_PORT:-3000}"
    volumes:
      - ./src:/app/src:cached
      - ./public:/app/public:cached
      - ./next.config.js:/app/next.config.js:cached
      - ./tailwind.config.js:/app/tailwind.config.js:cached
      - ./tsconfig.json:/app/tsconfig.json:cached
      - ./postcss.config.js:/app/postcss.config.js:cached
      - ./components.json:/app/components.json:cached
      - node_modules:/app/node_modules
      - next_cache:/app/.next
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FRONTEND_INTERNAL_PORT:-3000}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# Volumes are prefixed with project name automatically (e.g., tl_ws1_pgdata)
volumes:
  pgdata:
  cargo_cache:
  target_cache:
  uploads:
  node_modules:
  next_cache:
